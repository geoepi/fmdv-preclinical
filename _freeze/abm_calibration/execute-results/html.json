{
  "hash": "a4a15c9696278d37b5ed8f4c43938b37",
  "result": {
    "markdown": "---\ntitle: \"ABM Calibration\"\ndescription: \"Finding values for ABM simulation.\"\nformat:\n  html: \n    df-print: kable\n    code-fold: show\n    code-summary: \"Hide code\"\n    code-overflow: wrap\n    toc-title: Page Contents\n    toc: true\n    toc-depth: 2\n    toc-location: right\n    number-sections: false\n    html-math-method: katex\n    smooth-scroll: true\neditor: source\neditor_options: \n  chunk_output_type: console\n---\n\n```{=html}\n<style type=\"text/css\">\n\nbody, td {\n   font-size: 13pt;\n}\ncode.r{\n  font-size: 9pt;\n}\npre {\n  font-size: 11pt\n}\n</style>\n```\n\n\n## Libraries\n\n::: {.cell}\n\n:::\n\n\n## Custom Functions\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n[1] 15000 15600 14400\n```\n:::\n:::\n\n\n## Read Data  \n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"2023-06-26\"\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 168  14\n```\n:::\n:::\n\n\n## Simple stats  \nStart of clinical presentation \n\n::: {.cell}\n\n```{.r .cell-code}\nfirst_score_gt_0 <- antem_df %>%\n  filter(score > 0) %>%\n  group_by(animal) %>%\n  slice_min(dpe) %>%   \n  ungroup()\n\nsummary_stats_first_gt_0 <- first_score_gt_0 %>%\n  summarise(\n    avg_nasal = mean(nasal, na.rm = TRUE),\n    sd_nasal = sd(nasal, na.rm = TRUE),\n    avg_serum = mean(serum, na.rm = TRUE),\n    sd_serum = sd(serum, na.rm = TRUE)\n  )\n\nsummary_stats_first_gt_0\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n| avg_nasal| sd_nasal| avg_serum|  sd_serum|\n|---------:|--------:|---------:|---------:|\n|  7.687973| 1.142453|  6.829318| 0.9029465|\n\n</div>\n:::\n\n```{.r .cell-code}\nplot(density(rnorm(1000, 7.69, 1.14)))\n```\n\n::: {.cell-output-display}\n![](abm_calibration_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\nStart of clinical presentation \n\n::: {.cell}\n\n```{.r .cell-code}\nfirst_grp2_transm <- antem_df %>%\n  filter(group == \"donor\",\n         dpi >= 2 & dpi <=3) \n\nfirst_grp2_transm\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|animal  |group |date       | dpi| dpe|    nasal|     serum| score| temp| hpdi| hpe|exp_type |fever | censor_status|\n|:-------|:-----|:----------|---:|---:|--------:|---------:|-----:|----:|----:|---:|:--------|:-----|-------------:|\n|BR23-17 |donor |2023-06-28 |   2|   2| 3.706999|  6.014235|     0|   NA|   48|  48|inoc     |NA    |             1|\n|BR23-17 |donor |2023-06-29 |   3|   3| 8.158363|  7.253855|     0|   NA|   72|  72|inoc     |NA    |             1|\n|BR23-18 |donor |2023-06-28 |   2|   2| 6.411625| 45.000000|     0|   NA|   48|  48|inoc     |NA    |             1|\n|BR23-18 |donor |2023-06-29 |   3|   3| 6.803084|  5.791815|     0|   NA|   72|  72|inoc     |NA    |             1|\n\n</div>\n:::\n\n```{.r .cell-code}\nmean(first_grp2_transm$nasal)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 6.270018\n```\n:::\n\n```{.r .cell-code}\nsd(first_grp2_transm$nasal)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1.865398\n```\n:::\n\n```{.r .cell-code}\nplot(density(rnorm(1000, 6.270018, 1.865398)))\n```\n\n::: {.cell-output-display}\n![](abm_calibration_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_value <- 6.270018  \nmax_value <- 8.16\nconfidence_level <- 0.99\nz_score <- qnorm((1 + confidence_level) / 2)  # Get the z-score\n\n# Calculate the standard deviation\nsd_value <- (max_value - mean_value) / z_score\n\ncat(\"Calculated standard deviation:\", sd_value, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCalculated standard deviation: 0.7337373 \n```\n:::\n\n```{.r .cell-code}\n# Generate random data based on calculated sd\nset.seed(123)  # For reproducibility\ndata <- rnorm(1000, mean = mean_value, sd = sd_value)\n\n# Plot the distribution\nlibrary(ggplot2)\nggplot(data.frame(x = data), aes(x)) +\n  geom_histogram(aes(y = ..density..), bins = 30, color = \"black\", fill = \"gray\") +\n  geom_vline(xintercept = max_value, linetype = \"dashed\", color = \"red\") +\n  labs(title = \"Normal Distribution with Limited Maximum Value\",\n       subtitle = paste(\"Mean =\", mean_value, \", SD =\", round(sd_value, 2)),\n       x = \"Value\",\n       y = \"Density\") +\n  theme_minimal()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: The dot-dot notation (`..density..`) was deprecated in ggplot2 3.4.0.\nâ„¹ Please use `after_stat(density)` instead.\n```\n:::\n\n::: {.cell-output-display}\n![](abm_calibration_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nEmpirical duration\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(antem_df)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|animal  |group |date       | dpi| dpe|     nasal|     serum| score| temp| hpdi| hpe|exp_type |fever | censor_status|\n|:-------|:-----|:----------|---:|---:|---------:|---------:|-----:|----:|----:|---:|:--------|:-----|-------------:|\n|BR23-17 |donor |2023-06-26 |   0|   0| 45.000000| 45.000000|     0|   NA|    0|   0|inoc     |NA    |             1|\n|BR23-17 |donor |2023-06-27 |   1|   1| 45.000000| 45.000000|     0|   NA|   24|  24|inoc     |NA    |             1|\n|BR23-17 |donor |2023-06-28 |   2|   2|  3.706999|  6.014235|     0|   NA|   48|  48|inoc     |NA    |             1|\n|BR23-17 |donor |2023-06-29 |   3|   3|  8.158363|  7.253855|     0|   NA|   72|  72|inoc     |NA    |             1|\n|BR23-17 |donor |2023-06-30 |   4|   4|  9.513642|  7.476275|     3|   NA|   96|  96|inoc     |NA    |             1|\n|BR23-17 |donor |2023-07-01 |   5|   5|  9.077699|  4.311981|     5|   NA|  120| 120|inoc     |NA    |             1|\n\n</div>\n:::\n\n```{.r .cell-code}\nemp_incub <- antem_df %>%\n  filter(score > 0,\n         group != \"Group 1\") %>%\n  group_by(animal) %>%\n  summarise(duration = min(dpe)) \n\nemp_incub\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|animal  | duration|\n|:-------|--------:|\n|BR23-17 |        4|\n|BR23-18 |        4|\n|BR23-23 |        5|\n|BR23-25 |        5|\n|BR23-26 |        4|\n|BR23-27 |        2|\n|BR23-28 |        2|\n|BR23-29 |        2|\n|BR23-30 |        2|\n|BR23-31 |        2|\n|BR23-32 |        3|\n|BR23-33 |        2|\n|BR23-34 |        3|\n\n</div>\n:::\n:::\n\n\n\ndpe 0 loads\n\n::: {.cell}\n\n```{.r .cell-code}\nemp_incub <- antem_df %>%\n  filter(score > 0 | group == \"Group 1\" & dpe == 0) %>%\n  group_by(group, animal) %>%\n  summarise(incubation = min(dpe)) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'group'. You can override using the\n`.groups` argument.\n```\n:::\n\n```{.r .cell-code}\ncorresponding_donors <- antem_df %>% \n  filter(group == \"donor\") %>%\n  mutate(nasal = if_else(nasal == 45, 0, nasal),\n         serum = if_else(serum == 45, 0, serum)\n  ) %>%\n  group_by(dpe) %>% \n   summarise(\n    mean_nasal = mean(nasal, na.rm = TRUE),\n    sd_nasal = sd(nasal, na.rm = TRUE),\n    mean_serum = mean(serum, na.rm = TRUE),\n    sd_serum = sd(serum, na.rm = TRUE)\n   ) %>%\n  filter(dpe <= 4) %>%\n  mutate(group = if_else(dpe == 0, \"donor\", \n                         paste(\"Group\", dpe)))\n\ncomb_df <- left_join(emp_incub, corresponding_donors, by = \"group\")\n  \ncomb_df <- comb_df %>%\n  select(animal, group, dpe, incubation, mean_nasal, sd_nasal, mean_serum, sd_serum)\n\ncomb_df\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|animal  |group   | dpe| incubation| mean_nasal|  sd_nasal| mean_serum|  sd_serum|\n|:-------|:-------|---:|----------:|----------:|---------:|----------:|---------:|\n|BR23-19 |Group 1 |   1|          0|   2.903322| 4.1059166|   0.000000| 0.0000000|\n|BR23-20 |Group 1 |   1|          0|   2.903322| 4.1059166|   0.000000| 0.0000000|\n|BR23-21 |Group 1 |   1|          0|   2.903322| 4.1059166|   0.000000| 0.0000000|\n|BR23-22 |Group 1 |   1|          0|   2.903322| 4.1059166|   0.000000| 0.0000000|\n|BR23-23 |Group 2 |   2|          5|   5.059312| 1.9124596|   3.007117| 4.2527063|\n|BR23-25 |Group 2 |   2|          5|   5.059312| 1.9124596|   3.007117| 4.2527063|\n|BR23-26 |Group 2 |   2|          4|   5.059312| 1.9124596|   3.007117| 4.2527063|\n|BR23-27 |Group 3 |   3|          2|   7.480724| 0.9583268|   6.522835| 1.0338186|\n|BR23-28 |Group 3 |   3|          2|   7.480724| 0.9583268|   6.522835| 1.0338186|\n|BR23-29 |Group 3 |   3|          2|   7.480724| 0.9583268|   6.522835| 1.0338186|\n|BR23-30 |Group 3 |   3|          2|   7.480724| 0.9583268|   6.522835| 1.0338186|\n|BR23-31 |Group 4 |   4|          2|   8.374852| 1.6104923|   7.130783| 0.4885999|\n|BR23-32 |Group 4 |   4|          3|   8.374852| 1.6104923|   7.130783| 0.4885999|\n|BR23-33 |Group 4 |   4|          2|   8.374852| 1.6104923|   7.130783| 0.4885999|\n|BR23-34 |Group 4 |   4|          3|   8.374852| 1.6104923|   7.130783| 0.4885999|\n|BR23-17 |donor   |   0|          4|   0.000000| 0.0000000|   0.000000| 0.0000000|\n|BR23-18 |donor   |   0|          4|   0.000000| 0.0000000|   0.000000| 0.0000000|\n\n</div>\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndonor_df <-  antem_df %>% \n  filter(group == \"donor\", dpe <= 5) %>%\n  select(group, animal, date, nasal)\n\nother_groups_df <-  antem_df %>%\n  filter(group != \"donor\", dpe <= 5) %>%\n  select(group, animal, date, nasal)\n\naligned_df <- other_groups_df %>%\n  left_join(donor_df %>% select(date, nasal) %>% \n              rename(donor_nasal = nasal), \n            by = \"date\", relationship = \"many-to-many\")\n\naligned_df$nasal[aligned_df$nasal == 45] = 0\naligned_df$donor_nasal[aligned_df$donor_nasal == 45] = 0\n\n\nmodel <- lm(nasal ~ donor_nasal, data = aligned_df)\nsummary(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = nasal ~ donor_nasal, data = aligned_df)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-3.357 -2.580 -1.405  2.187  6.908 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  -2.0993     1.0014  -2.096   0.0383 *  \ndonor_nasal   0.5735     0.1271   4.513 1.61e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 2.944 on 110 degrees of freedom\n  (40 observations deleted due to missingness)\nMultiple R-squared:  0.1562,\tAdjusted R-squared:  0.1486 \nF-statistic: 20.37 on 1 and 110 DF,  p-value: 1.611e-05\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncomp_nasal <- antem_df %>%\n  filter(group != \"Group 1\", dpe <= 5) %>%\n  select(animal, dpe, nasal) %>%\n  mutate(nasal = if_else(nasal == 45, 0, nasal)) %>% \n  pivot_wider(names_from = animal, values_from = nasal)\n\ndonor_cor <- comp_nasal %>%\n  select(dpe, `BR23-17`, `BR23-18`)%>%\n  filter(dpe <= 5) \n\ncontact_cor <- comp_nasal %>%\n  filter(dpe <= 5) %>%\n  select(-c(dpe, `BR23-17`, -`BR23-18`))\n\nmod_lm <- lm(contact_cor)\n\n\ncor(comp_nasal$`BR23-17`, comp_nasal$`BR23-23`, use=\"pairwise.complete\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.3235205\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnasal_lm <- lm(incubation ~ mean_nasal, comb_df)\nsummary(nasal_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = incubation ~ mean_nasal, data = comb_df)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-2.3149 -0.4016 -0.3874  1.6510  2.6510 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)  \n(Intercept)  2.26886    0.90106   2.518   0.0237 *\nmean_nasal   0.01584    0.14982   0.106   0.9172  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.748 on 15 degrees of freedom\nMultiple R-squared:  0.0007451,\tAdjusted R-squared:  -0.06587 \nF-statistic: 0.01118 on 1 and 15 DF,  p-value: 0.9172\n```\n:::\n\n```{.r .cell-code}\np1 <- ggplot(comb_df, aes(x = incubation, y = mean_nasal)) +\n  geom_point(color = \"blue\") + \n  geom_smooth(method = lm, se = FALSE, color = \"red\", linetype = \"dashed\") +\n  labs(title = \"Linear model: Incubation vs Mean Nasal\",\n       x = \"Incubation Period\",\n       y = \"Mean Nasal Values\") +\n  theme_minimal()\n\n\np2 <- ggplot(comb_df, aes(x = incubation, y = mean_serum)) +\n  geom_point(color = \"green\") + \n  geom_smooth(method = lm, se = FALSE, color = \"purple\", linetype = \"dashed\") +\n  labs(title = \"Linear model: Incubation vs Mean Serum\",\n       x = \"Incubation Period\",\n       y = \"Mean Serum Values\") +\n  theme_minimal()\n```\n:::\n\n\n\nObserved\n\n::: {.cell}\n\n```{.r .cell-code}\ndur_plt <- antem_df %>%\n  mutate(nasal = if_else(nasal == 45 | is.na(nasal), 0, nasal),\n         serum = if_else(serum == 45 | is.na(serum), 0, serum),\n         score = if_else(is.na(score), 0, score)) %>%\n  select(animal, date, nasal, serum, score)\n\ndur_processed <- dur_plt %>%\n  group_by(animal) %>%\n  arrange(date) %>%\n  mutate(\n    uninfected_end = ifelse(any(nasal > 0), min(date[nasal > 0]), NA),\n    infected_end = ifelse(any(score > 0), min(date[score > 0]), NA),\n    period = case_when(\n      date < uninfected_end | is.na(uninfected_end) ~ \"uninfected\",\n      date >= uninfected_end & date < infected_end | is.na(infected_end) ~ \"infected\",\n      date >= infected_end ~ \"clinical\"\n    )) %>%\n  select(animal, date, period)\n\ndur_long <- dur_processed %>%\n  group_by(animal, period) %>%\n  summarize(start_date = min(date), end_date = max(date), .groups = 'drop') %>%\n  arrange(animal, start_date) %>%\n  group_by(animal) %>%\n  mutate(animal_max_date = max(end_date)) %>%\n  ungroup() %>%\n  group_by(animal) %>%\n  mutate(next_start_date = lead(start_date),\n         adjusted_end_date = ifelse(is.na(next_start_date), animal_max_date + 1, next_start_date)) %>%\n  ungroup()\n\ndur_long$adjusted_end_date <- as.Date(dur_long$adjusted_end_date, format = \"%Y-%m-%d\")\n\nggplot(data = dur_long, aes(y = animal, fill = period)) +\n  geom_rect(aes(xmin = start_date, xmax = adjusted_end_date, ymin = as.numeric(as.factor(animal)) - 0.4,\n                ymax = as.numeric(as.factor(animal)) + 0.4),\n            color = \"black\") +\n  scale_x_date(date_breaks = \"1 day\", date_labels = \"%b %d\") +\n  labs(title = \" \", x = \" \", y = \"Animal ID\", fill = \"Period\") +\n  theme_minimal() +\n  theme(\n    panel.grid.major.x = element_line(color = \"gray\", linewidth = 0.5), \n    panel.grid.minor.x = element_blank(), \n    plot.margin = unit(c(1,0.75,1,0.75),\"cm\"),\n    legend.direction = \"horizontal\",\n    legend.position = \"none\",\n    strip.text = element_blank(), \n    strip.background = element_blank(),\n    legend.key.size = unit(2,\"line\"),\n    legend.key.width = unit(3,\"line\"),\n    legend.text = element_text(size=16, face=\"bold\"),\n    legend.title = element_text(size=18, face=\"bold\"),\n    axis.title.x = element_text(size=18, face=\"bold\"),\n    axis.title.y = element_text(size=22, face=\"bold\"),\n    axis.text.x = element_text(face=\"bold\", size=15, vjust=1, hjust=1, angle=45),\n    axis.text.y = element_text(size=18, face=\"bold\"),\n    plot.title = element_text(size=22, face=\"bold\")\n  )\n```\n\n::: {.cell-output-display}\n![](abm_calibration_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "abm_calibration_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}